name: Publish to npm

on:
    push:
        tags:
            - 'v*'
    workflow_dispatch:
        inputs:
            version:
                description: 'Version to publish (e.g., 0.5.2)'
                required: true
                type: string

permissions:
    contents: read
    id-token: write

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  registry-url: 'https://registry.npmjs.org'

            - name: Install dependencies
              run: bun install

            - name: Determine version
              id: version
              run: |
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                      echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
                  else
                      VERSION="${GITHUB_REF#refs/tags/v}"
                      echo "version=${VERSION}" >> $GITHUB_OUTPUT
                  fi

            - name: Build binaries with web assets
              run: bun run build:single-exe:all
              working-directory: cli

            - name: Prepare npm packages
              run: bun run prepare-npm-packages
              working-directory: cli

            - name: Publish platform packages
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
              run: |
                  for platform in darwin-arm64 darwin-x64 linux-arm64 linux-x64 win32-x64; do
                      echo "Publishing @flintttan/hapi-${platform}..."
                      cd npm/${platform}
                      npm publish --access public --provenance
                      cd ../..
                  done
              working-directory: cli

            - name: Publish main package
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
              run: |
                  cd npm/main
                  npm publish --access public --provenance
              working-directory: cli

            - name: Create GitHub Release
              if: github.event_name == 'push'
              uses: softprops/action-gh-release@v2
              with:
                  body: |
                      ## npm packages published

                      This release includes npm packages for all platforms:

                      - `@flintttan/hapi` (main package)
                      - `@flintttan/hapi-darwin-arm64`
                      - `@flintttan/hapi-darwin-x64`
                      - `@flintttan/hapi-linux-arm64`
                      - `@flintttan/hapi-linux-x64`
                      - `@flintttan/hapi-win32-x64`

                      Install with:
                      ```bash
                      npm install -g @flintttan/hapi
                      ```
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}